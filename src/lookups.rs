/* General lookups */

pub const DIV_LOOKUP: [u8; 81] = [0, 0, 0, 0, 0, 0, 0, 0, 0, 
                                  1, 1, 1, 1, 1, 1, 1, 1, 1,
                                  2, 2, 2, 2, 2, 2, 2, 2, 2,
                                  3, 3, 3, 3, 3, 3, 3, 3, 3,
                                  4, 4, 4, 4, 4, 4, 4, 4, 4,
                                  5, 5, 5, 5, 5, 5, 5, 5, 5,
                                  6, 6, 6, 6, 6, 6, 6, 6, 6,
                                  7, 7, 7, 7, 7, 7, 7, 7, 7,
                                  8, 8, 8, 8, 8, 8, 8, 8, 8];

pub const MOD_LOOKUP: [u8; 81] = [0, 1, 2, 3, 4, 5, 6, 7, 8, 
                                  0, 1, 2, 3, 4, 5, 6, 7, 8,
                                  0, 1, 2, 3, 4, 5, 6, 7, 8,
                                  0, 1, 2, 3, 4, 5, 6, 7, 8,
                                  0, 1, 2, 3, 4, 5, 6, 7, 8,
                                  0, 1, 2, 3, 4, 5, 6, 7, 8,
                                  0, 1, 2, 3, 4, 5, 6, 7, 8,
                                  0, 1, 2, 3, 4, 5, 6, 7, 8,
                                  0, 1, 2, 3, 4, 5, 6, 7, 8];

pub const SUB_LOOKUP: [u128; 9] = [0b000000000000000000000000000000000000000000000000000000000000000000000000111111111,
                                   0b000000000000000000000000000000000000000000000000000000000000000111111111000000000,
                                   0b000000000000000000000000000000000000000000000000000000111111111000000000000000000,
                                   0b000000000000000000000000000000000000000000000111111111000000000000000000000000000,
                                   0b000000000000000000000000000000000000111111111000000000000000000000000000000000000,
                                   0b000000000000000000000000000111111111000000000000000000000000000000000000000000000,
                                   0b000000000000000000111111111000000000000000000000000000000000000000000000000000000,
                                   0b000000000111111111000000000000000000000000000000000000000000000000000000000000000,
                                   0b111111111000000000000000000000000000000000000000000000000000000000000000000000000];

pub const WIN_LOOKUP: [u16; 8] = [0b000000111, 0b000111000, 0b001001001, 0b001010100, 0b010010010, 0b100010001, 0b100100100, 0b111000000];

// pub const DIAG_LOOKUP: [u16; 2] = [0b001010100, 0b100010001];
// pub const SIDE_LOOKUP: [u16; 4] = [0b000000111, 0b001001001, 0b100100100, 0b111000000];
// pub const CENT_LOOKUP: [u16; 2] = [0b000111000, 0b010010010];

pub const WIN_LOOKUP_INDEXED: [u16; 24] = [0b000000111, 0b001001001, 0b100010001,
                                           0b000000111, 0b010010010,
                                           0b000000111, 0b001010100, 0b100100100,
                                           0b000111000, 0b001001001,
                                           0b000111000, 0b001010100, 0b010010010, 0b100010001,
                                           0b000111000, 0b100100100,
                                           0b001001001, 0b001010100, 0b111000000,
                                           0b010010010, 0b111000000,
                                           0b100010001, 0b100100100, 0b111000000];

pub const WIN_LOOKUP_INDICES: [[usize; 2]; 9] = [[0, 3], [3, 2], [5, 3], [8, 2], [10, 4], [14, 2], [16, 3], [19, 2], [21, 3]];

// pub const BAD_LOOKUP: [u16; 4] = [0b001100010, 0b010001100, 0b010100001, 0b100001010];


/* Eval lookups */

const POS_CNT: [u8; 4] = [12, 8, 4, 0];

pub fn gen_local_maps() -> (Vec<u16>, Vec<u16>) {
    let mut xlocal = vec![0; 262144];
    let mut olocal = vec![0; 262144];
    
    for permut in 0usize..262144 {
        let mut xbits = (permut & 0b111111111) as u16;
        let mut obits = ((permut >> 9) & 0b111111111) as u16;

        // impossible
        if xbits & obits != 0 {
            continue;
        }

        let mut x_left = [0; 4];
        let mut o_left = [0; 4];

        for lookup in WIN_LOOKUP {
            let maskx = xbits & lookup;
            let masko = obits & lookup;
            
            if maskx != 0 && masko != 0 {
                continue;
            }
            if maskx == 0 && masko == 0 {
                x_left[3] += 1;
                o_left[3] += 1;
                continue
            }
            if maskx != 0 {
                match maskx.count_ones() {
                    1 => { x_left[2] += 1; },
                    2 => { x_left[1] += 1; },
                    3 => {
                        x_left[0] = 1;
                        break;
                    },
                    _ => {}
                }
            } else {
                match masko.count_ones() {
                    1 => { o_left[2] += 1; },
                    2 => { o_left[1] += 1; },
                    3 => {
                        o_left[0] = 1;
                        break;
                    },
                    _ => {}
                }
            }
        }

        if x_left[0] != 0 {
            xlocal[permut] = 1 << POS_CNT[0];
            continue;
        }
        if o_left[0] != 0 {
            olocal[permut] = 1 << POS_CNT[0];
            continue;
        }
        xlocal[permut] = x_left[1] << POS_CNT[1] | x_left[2] << POS_CNT[2] | x_left[3] << POS_CNT[3];
        olocal[permut] = o_left[1] << POS_CNT[1] | o_left[2] << POS_CNT[2] | o_left[3] << POS_CNT[3];
    }

    (xlocal, olocal)
}


#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn gen_local_maps_test() {
        let (xl, ol) = gen_local_maps();

        let t1 = 0b_000000000_000000000;
        assert_eq!(xl[t1], 8 << POS_CNT[3]);
        assert_eq!(ol[t1], 8 << POS_CNT[3]);

        let t2 = 0b_000000010_000000001;
        assert_eq!(xl[t1], 4 << POS_CNT[3] | 2 << POS_CNT[2]);
        assert_eq!(ol[t1], 4 << POS_CNT[3] | 1 << POS_CNT[2]);
    }
}